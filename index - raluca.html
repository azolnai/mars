<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Mars Jezero Crater | DevZolnai </title>
    <style>
      html,
      body,

      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1em;
        box-sizing: border-box;
      }

      #introDiv {
        position: relative;
        width: 60%;
        max-width: 700px;
        min-height: 350px;
        flex: 1;
        background-color: #fff;
        padding: 3em;
        box-sizing: border-box;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
      }

      #introDiv h1 {
        margin-top: 0;
        margin-bottom: 1em;
      }

      #introDiv p {
        line-height: 1.5em;
      }

      #container a:hover {
        color: white;
        background: rgb(2, 105, 161);
      }

      #container a {
        color: rgb(2, 105, 161);
        text-decoration: none;
        font-weight: bold;
      }

      button.esri-icon-close {
        position: absolute;
        top: 1.5em;
        right: 1.5em;
        background: transparent;
        border: none;
        cursor: pointer;
      }

      #about {
        color: white;
        box-shadow: none;
        cursor: pointer;
      }

      .hidden {
        display: none;
      }

      #start-globe {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
        }

</style>

    <link rel="stylesheet" href="https://js.arcgis.com/4.18/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.18/"></script>

    <script>
require([
        "esri/esriConfig",
        "esri/Map",
        "esri/views/SceneView",
        "esri/layers/ElevationLayer",
        "esri/layers/TileLayer",
        "esri/layers/FeatureLayer",
        "esri/widgets/LayerList",
        "esri/Graphic",
        "esri/Geometry/Point",
        "esri/core/watchUtils"
      ], function (esriConfig, Map, SceneView, ElevationLayer, TileLayer, FeatureLayer, LayerList, Graphic, Point, watchUtils) {

        esriConfig.apiKey = "AAPKf6ee9e6e727240e0a03cab46b71a760drZn_p6rMQF3cUUli_rnM1yQ-wLfg6u35jKee8cBOIVgbkxsVGcc9MqIoSkGL63na";        

        const marsElevation = new ElevationLayer({
          url:
            "https://astro.arcgis.com/arcgis/rest/services/OnMars/MDEM200M/ImageServer",
          copyright:
            "NASA, ESA, HRSC, Goddard Space Flight Center, USGS Astrogeology Science Center, Esri"
        });

        const marsImageryCTX = new TileLayer({
          url:
            "https://astro.arcgis.com/arcgis/rest/services/OnMars/CTX/MapServer",
            title: "Imagery CTX",
          copyright: "USGS Astrogeology Science Center, NASA, JPL, Esri"
        });

       const map = new Map({
          ground: {
            layers: [marsElevation]
          },
          layers: [marsImageryCTX],
        });

        const view = new SceneView({
          map: map,
          container: "viewDiv",
          qualityProfile: "high",
          // setting the spatial reference for Mars_2000 coordinate system
          spatialReference: {
            wkid: 104971
          },
          camera: {
            position: {
              x: 77.5000,
              y: 18.5000,
              z: 8000.000,
              spatialReference: 104971
            },
            heading: -90.00,
            tilt: 37.12
          }
        });

        const cratersLayer = new FeatureLayer({
          url:
            "https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/Mars_Nomenclature_Craters/FeatureServer",
          definitionExpression: "type = 'Crater, craters'",
          title: "Mars Craters",
          renderer: {
            type: "simple",
            symbol: {
              type: "polygon-3d",
              symbolLayers: [
                {
                  type: "fill",
                  material: { color: [255, 255, 255, 0.1] },
                  outline: {
                    color: [0, 0, 0, 0.4],
                    size: 2
                  }
                }
              ]
            }
          },
          labelingInfo: [
            {
              labelPlacement: "above-center",
              labelExpressionInfo: { expression: "$feature.NAME" },
              symbol: {
                type: "label-3d",
                symbolLayers: [
                  {
                    type: "text",
                    material: {
                      color: [0, 0, 0, 0.9]
                    },
                    halo: {
                      size: 2,
                      color: [255, 255, 255, 0.7]
                    },
                    font: {
                      size: 10
                    }
                  }
                ],
                verticalOffset: {
                  screenLength: 40,
                  maxWorldLength: 500000,
                  minWorldLength: 0
                },
                callout: {
                  type: "line",
                  size: 0.5,
                  color: [255, 255, 255, 0.9],
                  border: {
                    color: [0, 0, 0, 0.3]
                  }
                }
              }
            }
          ]
        });

        map.add(cratersLayer);

        const shadedReliefLayer = new TileLayer({
          url:
            "https://astro.arcgis.com/arcgis/rest/services/OnMars/MColorDEM/MapServer",
          copyright: "USGS Astrogeology Science Center, NASA, JPL, ESA, DLR, Esri",
          title: "Shaded relief",
          visible: false
        });

        map.add(shadedReliefLayer);

        const marsImageryMDIM = new TileLayer({
          url:
            "https://astro.arcgis.com/arcgis/rest/services/OnMars/MDIM/MapServer",
            title: "Imagery MDIM",
          copyright: "USGS Astrogeology Science Center, NASA, JPL, Esri",
          visible: false
        });

        map.add(marsImageryMDIM);

        const marsImageryHiRISE = new TileLayer({
          url:
            "https://astro.arcgis.com/arcgis/rest/services/OnMars/HiRISE/MapServer",
            title: "Imagery HiRISE",
          copyright: "USGS Astrogeology Science Center, NASA, JPL, Esri",
          visible: false
        });

        map.add(marsImageryHiRISE);

        const jezeroNiliTiles = new TileLayer({
          url:
            "https://tiles.arcgis.com/tiles/v01gqwM5QqNysAAi/arcgis/rest/services/Nili_CTX_Mosaic_Beta01_Feb2018_MTM_tif_NEWTILING5/MapServer",
            title: "Jezero Nili Tiles",
          copyright: "Geologic Map of Jezero Crater and the Nili Planum Region, Mars, 1:75,000. Sun and Stack (2020)",
          visible: false
        });

        map.add(jezeroNiliTiles);

        const JezeroGeolUnits = new TileLayer({
          url:
            "https://tiles.arcgis.com/tiles/v01gqwM5QqNysAAi/arcgis/rest/services/JezeroGeoUnitsAnno_WebTile2/MapServer",
            title: "Jezero Geol. Units",
          copyright: "Geologic Map of Jezero Crater and the Nili Planum Region, Mars, 1:75,000. Sun and Stack (2020)",
          visible: false
        });

        map.add(JezeroGeolUnits);

        const JezeroGeology = new FeatureLayer({
          url:
            "https://services.arcgis.com/v01gqwM5QqNysAAi/arcgis/rest/services/Jezero_FeatureServiceFromPro/FeatureServer",
            definitionExpression: "name = 'Geologic Contacts'",
            title: "Geologic Contacts",
          copyright: "Geologic Map of Jezero Crater and the Nili Planum Region, Mars, 1:75,000. Sun and Stack (2020)",
            title: "Geologic Contacts",
            renderer: {
            type: "simple",
            symbol: {
              type: "esriSFS",
              symbolLayers: [
                {
                  type: "esrSFS",
                  material: { color: [130, 130, 130, 0] },
                  outline: {
                    color: [0, 0, 0, 255],
                    size: 2
                  }
                }
              ]
            }
          },
          visible: false
        });

        map.add(JezeroGeology);

        const layerList = new LayerList({
          view
        });

        view.ui.add(layerList, {
            position: "top-right"
          });    

      document.getElementById("close-about").addEventListener("click", closeMenu);

      document.getElementById("start-globe").addEventListener("click", function () {
        closeMenu();
        view.when(function () {
          watchUtils.whenFalseOnce(view, "updating", rotate);
        });
      });

      document.getElementById("container").addEventListener("click", function (e) {
        if (e.target.id === "container") {
          closeMenu();
          view.when(function () {
            watchUtils.whenFalseOnce(view, "updating", rotate);
          });
        }
      });

      function closeMenu() {
        document.getElementById("container").style.display = "none";
        view.container.style.filter = "blur(0px)";
      }

      let intro = true;
      document.getElementById("about").addEventListener("click", function () {
        document.getElementById("container").style.display = "flex";
        view.container.style.filter = "blur(10px)";
        if (intro) {
          document.getElementById("show-about").classList.remove("hidden");
          document.getElementById("show-intro").classList.add("hidden");
          intro = false;
        }
      });

      view.ui.add("about", "bottom-left");

      function rotate() {
        if (!view.interacting) {
          const camera = view.camera.clone();
          camera.position.longitude -= 0.2;
          view.goTo(camera, { animate: false });
          requestAnimationFrame(rotate);
        }
      }
    });

    </script>
  </head>

  <body>

    <div id="viewDiv">
      <div id="about">About this map</div>
    </div>
    <div id="container">
      <div id="introDiv">
        <h1>#MARS2021</h1>
        <div id="show-intro">
          <p> Where has NASA Perseverance Rover landed on Mars? On the Jezero Crater! Turn on the HiRISE imagery and examine the deltaic landforms, thought to possibly hold signs of early organic matter.
            Rivers are thought to have flowed on Mars' surface 3+B years ago, before it was degased into the current red desert planet.
          </p>
          <button id="start-globe">Go to globe</button>
        </div>
        <div id="show-about" class="hidden">
            <button id="close-about" class="esri-icon-close"></button>
          <p>This web scene was insprired by "Explore Mars with GIS", <a href="https://explore-mars.herokuapp.com/" target="_blank"></a>the app</p>a> and <a href="https://www.esri.com/arcgis-blog/products/js-api-arcgis/3d-gis/explore-mars-with-gis/" target="_blank"></a>the story</a>, HT <a href="https://twitter.com/PhilipMielke" target="_blank"></a>@PhilipMielke</a>.
          <br>See also this story map <a href="https://arcg.is/1KmS5S0" target="_blank">Mars revisited</a> and this blog <a href="https://blog.zolnai.ca/2021/02/adventures-in-ar-augmented-reality.html" target="_blank">Adventures in AR (augemnted reality)</a> for background and more 3D viz.
          <br>The HTML code benefited from <a href="https://learn.arcgis.com/en/projects/build-a-3d-globe-app-with-the-arcgis-api-for-javascript/" target="_blank">Build a 3D globe app with the ArcGIS API for JavaScript</a>, and from <a href="https://www.esri.com/arcgis-blog/products/js-api-arcgis/3d-gis/interactive-3d-globe/" target="_blank">An interactive 3D globe of extremes - a DIY mapping guide</a>.</p>
        </div>
      </div>
    </div>

  </body>
</html>